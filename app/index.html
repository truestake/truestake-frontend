<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TrueStake</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #050816;
      --bg-soft: #0b1020;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --text: #f9fafb;
      --text-soft: #9ca3af;
      --danger: #f97316;
      --radius-xl: 18px;
      --radius-lg: 14px;
      --radius-md: 10px;
      --border-subtle: rgba(148, 163, 253, 0.12);
      --shadow-soft: 0 16px 40px rgba(15,23,42,0.45);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", -system-ui, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #020817 0, #01040b 40%, #000 100%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      padding: 10px;
      overflow: hidden;
    }

    .app {
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100vh;
    }

    /* –®–ê–ü–ö–ê */

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: var(--radius-xl);
      background: linear-gradient(135deg, rgba(15,23,42,0.95), rgba(4,7,20,0.98));
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-subtle);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-logo {
      width: 22px;
      height: 22px;
      border-radius: 8px;
      background: radial-gradient(circle at 30% 0, #38bdf8, #4f46e5);
      box-shadow: 0 0 18px rgba(56,189,248,0.6);
    }

    .brand-title {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }

    .brand-title span:nth-child(1) {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .brand-title span:nth-child(2) {
      font-size: 10px;
      color: var(--text-soft);
    }

    .user-pill {
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      display: flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(148,163,253,0.25);
      font-size: 9px;
      color: var(--text-soft);
    }

    .user-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34,197,94,0.9);
    }

    .role-badge {
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 8px;
      background: rgba(56,189,248,0.14);
      color: var(--accent);
    }

    /* –†–£–ë–†–ò–ö–ò */

    .categories-row {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      padding: 2px 2px 0;
      scrollbar-width: none;
    }
    .categories-row::-webkit-scrollbar { display: none; }

    .cat-pill {
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 9px;
      border: 1px solid rgba(148,163,253,0.18);
      color: var(--text-soft);
      white-space: nowrap;
      background: rgba(9,9,20,0.96);
    }
    .cat-pill.active {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: rgba(56,189,248,0.7);
    }

    /* –ü–û–ò–°–ö + –§–ò–õ–¨–¢–† */

    .search-row {
      display: flex;
      gap: 6px;
      margin-top: 2px;
    }

    .search-input-wrap {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 7px 9px;
      border-radius: var(--radius-lg);
      background: rgba(5,10,25,0.98);
      border: 1px solid rgba(75,85,99,0.7);
    }

    .search-input-wrap input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text);
      font-size: 10px;
    }

    .search-input-wrap input::placeholder {
      color: var(--text-soft);
    }

    .filter-btn {
      width: 40px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(75,85,99,0.8);
      background: rgba(5,10,25,0.98);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--accent);
    }

    /* –õ–ï–ù–¢–ê (3.5 –∫–∞—Ä—Ç–æ—á–∫–∏) */

    .markets-wrap {
      flex: 1;
      margin-top: 4px;
      padding: 6px 2px 4px;
      border-radius: var(--radius-xl);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.06), transparent),
                  rgba(3,7,18,0.98);
      border: 1px solid rgba(31,41,55,0.9);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow: hidden;
    }

    .markets-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: thin;
    }

    .market-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 7px 8px;
      margin-bottom: 4px;
      border-radius: var(--radius-md);
      background: rgba(9,9,20,0.98);
      border: 1px solid rgba(75,85,99,0.55);
      box-shadow: 0 6px 16px rgba(15,23,42,0.55);
      min-height: 46px;
      max-height: 46px; /* –¥–∞—ë—Ç —ç—Ñ—Ñ–µ–∫—Ç "3.5 –∫–∞—Ä—Ç–æ—á–∫–∏" –Ω–∞ –Ω–µ–±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    }

    .market-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
      overflow: hidden;
    }

    .market-question {
      font-size: 10px;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .market-meta {
      display: flex;
      gap: 6px;
      font-size: 8px;
      color: var(--text-soft);
      align-items: center;
    }

    .meta-pill {
      padding: 1px 5px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.8);
      font-size: 7px;
      color: var(--accent);
    }

    .market-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
      min-width: 52px;
    }

    .yes-label {
      font-size: 8px;
      color: var(--text-soft);
    }

    .yes-value {
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
    }

    .vol {
      font-size: 7px;
      color: var(--text-soft);
    }

    .status-badge {
      padding: 1px 4px;
      border-radius: 6px;
      font-size: 7px;
      text-transform: uppercase;
      border: 1px solid rgba(56,189,248,0.4);
      color: var(--accent);
    }

    .status-pending {
      border-color: rgba(249,115,22,0.5);
      color: var(--danger);
    }

    /* –ü–û–î–í–ê–õ */

    .footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 10px;
      margin-top: 2px;
      border-radius: var(--radius-xl);
      background: rgba(3,7,18,0.98);
      border: 1px solid rgba(31,41,55,0.95);
      box-shadow: 0 -8px 20px rgba(0,0,0,0.7);
      font-size: 8px;
      color: var(--text-soft);
      gap: 8px;
    }

    .footer-left, .footer-right {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .f-btn {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.9);
      font-size: 8px;
      color: var(--text-soft);
      background: transparent;
    }

    .f-btn.primary {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(56,189,248,0.1);
    }

    .create-btn {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.9);
      font-size: 8px;
      color: var(--accent);
      background: rgba(8,47,73,0.95);
      display: none; /* –≤–∫–ª—é—á–∞–µ–º –≤ JS, –µ—Å–ª–∏ role=creator/admin */
    }

  </style>
</head>
<body>
<div class="app">
  <!-- header -->
  <div class="header">
    <div class="brand">
      <div class="brand-logo"></div>
      <div class="brand-title">
        <span>TrueStake</span>
        <span>on TON ¬∑ Telegram Mini App</span>
      </div>
    </div>
    <div class="user-pill" id="user-pill">
      <div class="user-dot"></div>
      <span id="user-label">guest</span>
      <span class="role-badge" id="role-badge" style="display:none;"></span>
    </div>
  </div>

  <!-- categories -->
  <div class="categories-row" id="categories">
    <div class="cat-pill active" data-cat="all">All</div>
    <div class="cat-pill" data-cat="politics">Politics</div>
    <div class="cat-pill" data-cat="economy">Economy</div>
    <div class="cat-pill" data-cat="crypto">Crypto</div>
    <div class="cat-pill" data-cat="sports">Sports</div>
    <div class="cat-pill" data-cat="world">World</div>
    <div class="cat-pill" data-cat="custom">Other</div>
  </div>

  <!-- search + filter -->
  <div class="search-row">
    <div class="search-input-wrap">
      <span style="font-size:11px;color:var(--accent);">üîç</span>
      <input id="search-input" placeholder="Search markets..." />
    </div>
    <button class="filter-btn" id="filter-btn">‚ò∞</button>
  </div>

  <!-- markets list -->
  <div class="markets-wrap">
    <div class="markets-list" id="markets-list">
      <!-- —Å—é–¥–∞ –ª–µ—Ç—è—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ -->
    </div>
  </div>

  <!-- footer -->
  <div class="footer">
    <div class="footer-left">
      <div class="f-btn primary">Markets</div>
      <div class="f-btn">Portfolio</div>
    </div>
    <div class="footer-right">
      <button class="create-btn" id="create-btn">+ Create</button>
      <div class="f-btn">‚ò∞</div>
    </div>
  </div>
</div>

<script>
  const API_BASE = "https://api.corsarinc.ru";

  const state = {
    token: null,
    user: null,
    markets: [],
    category: "all",
    search: ""
  };

  function setUserInfo(user, role) {
    const pill = document.getElementById("user-pill");
    const label = document.getElementById("user-label");
    const roleBadge = document.getElementById("role-badge");
    const createBtn = document.getElementById("create-btn");

    if (!user) {
      label.textContent = "guest";
      roleBadge.style.display = "none";
      createBtn.style.display = "none";
      return;
    }

    label.textContent = user.username
      ? "@" + user.username
      : (user.id || "user");

    if (role === "admin" || role === "creator") {
      roleBadge.textContent = role.toUpperCase();
      roleBadge.style.display = "inline-block";
      createBtn.style.display = "inline-block";
    } else {
      roleBadge.style.display = "none";
      createBtn.style.display = "none";
    }
  }

  function renderMarkets() {
    const list = document.getElementById("markets-list");
    list.innerHTML = "";

    let items = state.markets || [];

    if (state.category && state.category !== "all") {
      items = items.filter(m => (m.category || "").toLowerCase() === state.category);
    }

    if (state.search) {
      const q = state.search.toLowerCase();
      items = items.filter(m => (m.question || "").toLowerCase().includes(q));
    }

    if (!items.length) {
      const div = document.createElement("div");
      div.style.padding = "8px";
      div.style.fontSize = "9px";
      div.style.color = "#6b7280";
      div.textContent = "No markets yet. Admin can activate, creators can add.";
      list.appendChild(div);
      return;
    }

    items.forEach(m => {
      const card = document.createElement("div");
      card.className = "market-card";

      const left = document.createElement("div");
      left.className = "market-main";

      const q = document.createElement("div");
      q.className = "market-question";
      q.textContent = m.question || "";

      const meta = document.createElement("div");
      meta.className = "market-meta";

      const cat = document.createElement("span");
      cat.className = "meta-pill";
      cat.textContent = (m.category || "global").toUpperCase();
      meta.appendChild(cat);

      if (m.resolution_ts) {
        const dt = document.createElement("span");
        dt.textContent = "End: " + m.resolution_ts.slice(0, 10);
        meta.appendChild(dt);
      }

      const st = document.createElement("span");
      st.className = "status-badge " + (m.status === "pending" ? "status-pending" : "");
      st.textContent = m.status;
      meta.appendChild(st);

      left.appendChild(q);
      left.appendChild(meta);

      const right = document.createElement("div");
      right.className = "market-right";

      const yesLabel = document.createElement("div");
      yesLabel.className = "yes-label";
      yesLabel.textContent = "YES";
      right.appendChild(yesLabel);

      const yesVal = document.createElement("div");
      yesVal.className = "yes-value";
      const p = typeof m.prob_yes === "number" ? m.prob_yes : m.probability_yes;
      yesVal.textContent = (p != null ? p : 50).toFixed(0) + "%";
      right.appendChild(yesVal);

      const vol = document.createElement("div");
      vol.className = "vol";
      vol.textContent = "Vol: $" + (m.volume_usd || 0).toFixed(0);
      right.appendChild(vol);

      card.appendChild(left);
      card.appendChild(right);

      list.appendChild(card);
    });
  }

  async function loadMarkets() {
    try {
      const r = await fetch(API_BASE + "/markets?status=active", {
        method: "GET"
      });
      const data = await r.json();
      if (data && data.ok) {
        state.markets = data.markets || [];
        renderMarkets();
      } else {
        console.log("markets error", data);
      }
    } catch (e) {
      console.log("markets fetch failed", e);
    }
  }

  async function authViaTelegram() {
    const tg = window.Telegram && window.Telegram.WebApp;
    if (!tg || !tg.initData) {
      // –û—Ç–∫—Ä—ã—Ç–æ –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ
      setUserInfo(null, null);
      renderMarkets();
      return;
    }

    try {
      const res = await fetch(API_BASE + "/auth/telegram", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ init_data: tg.initData })
      });
      const data = await res.json();

      if (data.ok && data.token && data.user) {
        state.token = data.token;
        state.user = data.user;

        // –î–æ–ø. –∑–∞–ø—Ä–æ—Å /auth/me, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å role (–µ—Å–ª–∏ backend —É–∂–µ –æ—Ç–¥–∞—ë—Ç)
        try {
          const meRes = await fetch(API_BASE + "/auth/me", {
            headers: { "Authorization": "Bearer " + state.token }
          });
          const me = await meRes.json();
          if (me.ok && me.user) {
            state.user = me.user;
          }
        } catch (e) {
          console.log("auth/me failed", e);
        }

        const role = state.user.role || null;
        setUserInfo(state.user, role);
      } else {
        setUserInfo(null, null);
      }
    } catch (e) {
      console.log("auth error", e);
      setUserInfo(null, null);
    }

    await loadMarkets();
  }

  function setupUI() {
    const cats = document.querySelectorAll(".cat-pill");
    cats.forEach(el => {
      el.addEventListener("click", () => {
        cats.forEach(c => c.classList.remove("active"));
        el.classList.add("active");
        state.category = el.dataset.cat || "all";
        renderMarkets();
      });
    });

    const searchInput = document.getElementById("search-input");
    searchInput.addEventListener("input", (e) => {
      state.search = e.target.value.trim();
      renderMarkets();
    });

    const filterBtn = document.getElementById("filter-btn");
    filterBtn.addEventListener("click", () => {
      alert("Advanced filters will be here (date, liquidity, volume, etc.).");
    });

    const createBtn = document.getElementById("create-btn");
    createBtn.addEventListener("click", () => {
      alert("Create Event: next step ‚Äî —Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä—ã–Ω–∫–∞ –¥–ª—è CREATOR/ADMIN.");
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    try {
      const tg = window.Telegram && window.Telegram.WebApp;
      if (tg) {
        tg.expand();
        tg.setBackgroundColor("#050816");
        tg.setHeaderColor("#050816");
      }
    } catch (e) {}
    setupUI();
    authViaTelegram();
  });
</script>
</body>
</html>
